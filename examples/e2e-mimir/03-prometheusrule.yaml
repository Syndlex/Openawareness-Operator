apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: devops-pipeline-rules
  labels:
    app.kubernetes.io/name: openawareness-controller
    app.kubernetes.io/component: prometheus-rules
    app.kubernetes.io/instance: e2e-mimir
    environment: e2e-test
    team: devops
    prometheus: devops
    role: alert-rules
  annotations:
    # Reference to the ClientConfig that provides Mimir connection details
    openawareness.io/client-name: "e2e-mimir-client"
    # Mimir namespace/tenant for these rules
    # This ensures rules are isolated to the devops-team tenant
    openawareness.io/mimir-namespace: "devops-team"
spec:
  groups:
    # Pipeline health monitoring rules
    - name: pipeline.health
      interval: 30s
      rules:
        # Alert when pipeline failure rate is high
        - alert: PipelineHighFailureRate
          expr: |
            (
              rate(pipeline_runs_failed_total[5m])
              /
              rate(pipeline_runs_total[5m])
            ) > 0.1
          for: 5m
          labels:
            severity: warning
            component: pipeline
            team: devops
          annotations:
            summary: "High pipeline failure rate detected"
            description: |
              Pipeline failure rate is {{ $value | humanizePercentage }} over the last 5 minutes.
              More than 10% of pipeline runs are failing.
            runbook_url: "https://wiki.example.org/runbooks/pipeline-failures"
        
        # Alert when pipeline failure rate is critical
        - alert: PipelineCriticalFailureRate
          expr: |
            (
              rate(pipeline_runs_failed_total[5m])
              /
              rate(pipeline_runs_total[5m])
            ) > 0.5
          for: 2m
          labels:
            severity: critical
            component: pipeline
            team: devops
          annotations:
            summary: "Critical pipeline failure rate"
            description: |
              Pipeline failure rate is {{ $value | humanizePercentage }} over the last 5 minutes.
              More than 50% of pipeline runs are failing. Immediate attention required.
            runbook_url: "https://wiki.example.org/runbooks/pipeline-critical-failures"
        
        # Alert when pipeline is stuck
        - alert: PipelineStuck
          expr: |
            time() - pipeline_last_run_timestamp_seconds > 3600
          for: 10m
          labels:
            severity: warning
            component: pipeline
            team: devops
          annotations:
            summary: "Pipeline has not run for over an hour"
            description: |
              Pipeline {{ $labels.pipeline }} has not completed a run in {{ $value | humanizeDuration }}.
              Last successful run was over 1 hour ago.
            runbook_url: "https://wiki.example.org/runbooks/pipeline-stuck"

    # Service availability rules
    - name: service.availability
      interval: 30s
      rules:
        # Alert when service is down
        - alert: ServiceDown
          expr: up{job="devops-services"} == 0
          for: 2m
          labels:
            severity: critical
            team: devops
          annotations:
            summary: "Service {{ $labels.instance }} is down"
            description: |
              Service {{ $labels.job }} on instance {{ $labels.instance }} has been down for more than 2 minutes.
            runbook_url: "https://wiki.example.org/runbooks/service-down"
        
        # Alert when service has high error rate
        - alert: ServiceHighErrorRate
          expr: |
            (
              rate(http_requests_total{status=~"5.."}[5m])
              /
              rate(http_requests_total[5m])
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            team: devops
          annotations:
            summary: "High error rate on {{ $labels.service }}"
            description: |
              Service {{ $labels.service }} is experiencing a {{ $value | humanizePercentage }} error rate.
              More than 5% of requests are returning 5xx errors.
            runbook_url: "https://wiki.example.org/runbooks/high-error-rate"
        
        # Recording rule for service availability percentage
        - record: service:availability:ratio
          expr: |
            avg_over_time(up{job="devops-services"}[5m])
          labels:
            team: devops

    # Resource utilization rules
    - name: resource.utilization
      interval: 30s
      rules:
        # Alert when CPU usage is high
        - alert: HighCPUUsage
          expr: |
            (
              100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
            ) > 80
          for: 10m
          labels:
            severity: warning
            team: devops
          annotations:
            summary: "High CPU usage on {{ $labels.instance }}"
            description: |
              CPU usage on {{ $labels.instance }} is {{ $value | humanize }}%.
              This has been above 80% for more than 10 minutes.
            runbook_url: "https://wiki.example.org/runbooks/high-cpu"
        
        # Alert when memory usage is high
        - alert: HighMemoryUsage
          expr: |
            (
              (
                node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes
              )
              /
              node_memory_MemTotal_bytes
            ) * 100 > 90
          for: 5m
          labels:
            severity: critical
            team: devops
          annotations:
            summary: "High memory usage on {{ $labels.instance }}"
            description: |
              Memory usage on {{ $labels.instance }} is {{ $value | humanize }}%.
              Available memory is critically low.
            runbook_url: "https://wiki.example.org/runbooks/high-memory"
        
        # Recording rule for average CPU usage
        - record: instance:cpu_usage:avg5m
          expr: |
            100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          labels:
            team: devops

    # Build and deployment rules
    - name: build.deployment
      interval: 1m
      rules:
        # Alert when build duration is too long
        - alert: SlowBuildTime
          expr: |
            histogram_quantile(0.95, 
              rate(build_duration_seconds_bucket[10m])
            ) > 600
          for: 5m
          labels:
            severity: warning
            component: pipeline
            team: devops
          annotations:
            summary: "Build time is too slow"
            description: |
              95th percentile of build duration is {{ $value | humanizeDuration }}.
              Builds are taking longer than 10 minutes.
            runbook_url: "https://wiki.example.org/runbooks/slow-builds"
        
        # Alert when deployment failed
        - alert: DeploymentFailed
          expr: |
            deployment_status{status="failed"} == 1
          for: 1m
          labels:
            severity: critical
            component: pipeline
            team: devops
          annotations:
            summary: "Deployment failed for {{ $labels.environment }}"
            description: |
              Deployment to {{ $labels.environment }} environment has failed.
              Application: {{ $labels.application }}
            runbook_url: "https://wiki.example.org/runbooks/deployment-failed"
        
        # Recording rule for successful deployment rate
        - record: deployment:success:rate5m
          expr: |
            rate(deployment_status{status="success"}[5m])
          labels:
            team: devops
