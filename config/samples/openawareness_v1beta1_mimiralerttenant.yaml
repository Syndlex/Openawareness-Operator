apiVersion: openawareness.syndlex/v1beta1
kind: MimirAlertTenant
metadata:
  name: mimiralerttenant-sample
  labels:
    app.kubernetes.io/name: openawareness-controller
    app.kubernetes.io/component: alert-config
  annotations:
    # Reference to the ClientConfig that provides Mimir connection details
    openawareness.io/client-name: "clientconfig-sample"
    # Mimir namespace/tenant for this alertmanager configuration
    openawareness.io/mimir-tenant: "default-tenant"
spec:
  # Template files for notification templates
  templateFiles:
    default_template: |
      {{ define "__alertmanager" }}AlertManager{{ end }}
      {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver | urlquery }}{{ end }}
      
      {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }}{{ end }}
      
      {{ define "__text_alert_list" }}{{ range . }}
      *Alert:* {{ .Labels.alertname }}
      *Severity:* {{ .Labels.severity }}
      *Summary:* {{ .Annotations.summary }}
      *Description:* {{ .Annotations.description }}
      {{ end }}{{ end }}

  # Alertmanager configuration in YAML format
  alertmanagerConfig: |
    global:
      smtp_smarthost: 'localhost:1025'
      smtp_from: 'alertmanager@example.org'
      smtp_require_tls: false
    
    templates:
      - 'default_template'
    
    route:
      receiver: 'team-default'
      group_by: ['alertname', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      
      routes:
        - match:
            severity: critical
          receiver: 'team-critical'
          group_wait: 10s
        
        - match:
            severity: warning
          receiver: 'team-warning'
    
    receivers:
      - name: 'team-default'
        email_configs:
          - to: 'team@example.org'
            headers:
              Subject: '{{ template "__subject" . }}'
            html: |
              <h2>Alert</h2>
              <p>{{ template "__text_alert_list" .Alerts }}</p>
            send_resolved: true
      
      - name: 'team-critical'
        email_configs:
          - to: 'oncall@example.org'
            headers:
              Subject: '[CRITICAL] {{ template "__subject" . }}'
              Priority: 'urgent'
            html: |
              <h1 style="color: red;">CRITICAL ALERT</h1>
              <p>{{ template "__text_alert_list" .Alerts }}</p>
            send_resolved: true
      
      - name: 'team-warning'
        email_configs:
          - to: 'team@example.org'
            headers:
              Subject: '[WARNING] {{ template "__subject" . }}'
            html: |
              <h2 style="color: orange;">Warning Alert</h2>
              <p>{{ template "__text_alert_list" .Alerts }}</p>
            send_resolved: true
    
    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname']